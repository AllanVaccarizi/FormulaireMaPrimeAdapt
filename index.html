<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo - Simulateur MaPrimeAdapt Modulaire</title>
    <style>
        /* Styles de base pour la d√©mo */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 40px 20px;
            background: #f5f5f5;
        }
        
        .demo-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .demo-title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <h1 class="demo-title">D√©mo - Simulateur MaPrimeAdapt (Version Modulaire)</h1>
        
        <!-- Le simulateur s'injecte ici -->
        <div id="maprimeadapt-simulator"></div>
    </div>

    <script>
        // CSS du simulateur (√† inclure dans votre page)
        const simulatorCSS = `
            .maprimeadapt-simulator {
                max-width: 600px;
                margin: 0 auto;
                background: white;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                overflow: hidden;
                font-family: Arial, sans-serif;
            }

            .maprimeadapt-simulator * {
                box-sizing: border-box;
            }

            .simulator-header {
                background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
                color: white;
                text-align: center;
                padding: 25px 20px;
            }

            .simulator-header h2 {
                margin: 0 0 10px 0;
                font-size: 22px;
                font-weight: bold;
            }

            .simulator-header p {
                margin: 0;
                opacity: 0.9;
                font-size: 14px;
            }

            .simulator-progress-bar {
                height: 4px;
                background: #e0e0e0;
                position: relative;
            }

            .simulator-progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #00b894, #55efc4);
                transition: width 0.5s ease;
                width: 0%;
            }

            .simulator-content {
                padding: 30px;
            }

            .simulator-question {
                display: none;
                animation: simulatorFadeIn 0.5s ease-in;
            }

            .simulator-question.active {
                display: block;
            }

            .simulator-question-title {
                font-size: 18px;
                font-weight: bold;
                color: #2c3e50;
                margin-bottom: 10px;
            }

            .simulator-question-subtitle {
                color: #7f8c8d;
                margin-bottom: 20px;
                font-size: 14px;
            }

            .simulator-options {
                display: grid;
                gap: 10px;
                margin-bottom: 25px;
            }

            .simulator-option {
                padding: 12px 16px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                background: white;
                font-size: 14px;
            }

            .simulator-option:hover {
                border-color: #3498db;
                transform: translateY(-1px);
                box-shadow: 0 3px 10px rgba(52, 152, 219, 0.2);
            }

            .simulator-option.selected {
                border-color: #00b894;
                background: #f8fffc;
                color: #00b894;
                font-weight: bold;
            }

            .simulator-input-group {
                margin-bottom: 15px;
            }

            .simulator-input-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                color: #2c3e50;
                font-size: 14px;
            }

            .simulator-input-group input {
                width: 100%;
                padding: 10px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                transition: border-color 0.3s;
            }

            .simulator-input-group input:focus {
                outline: none;
                border-color: #3498db;
            }

            .simulator-checkbox-group {
                display: flex;
                align-items: center;
                margin-top: 15px;
            }

            .simulator-checkbox-group input[type="checkbox"] {
                width: auto;
                margin-right: 8px;
            }

            .simulator-checkbox-group label {
                font-size: 14px;
                font-weight: normal;
            }

            .simulator-buttons {
                display: flex;
                gap: 15px;
                justify-content: space-between;
                margin-top: 20px;
            }

            .simulator-btn {
                padding: 10px 25px;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .simulator-btn-primary {
                background: linear-gradient(135deg, #00b894, #55efc4);
                color: white;
            }

            .simulator-btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3);
            }

            .simulator-btn-secondary {
                background: #95a5a6;
                color: white;
            }

            .simulator-btn-secondary:hover {
                background: #7f8c8d;
            }

            .simulator-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .simulator-result {
                display: none;
                text-align: center;
                padding: 25px;
                background: linear-gradient(135deg, #00b894, #55efc4);
                color: white;
                border-radius: 10px;
                margin-top: 20px;
            }

            .simulator-result.show {
                display: block;
                animation: simulatorFadeIn 0.5s ease-in;
            }

            .simulator-result.ineligible {
                background: linear-gradient(135deg, #e74c3c, #c0392b);
            }

            .simulator-ineligible-message {
                display: none;
                text-align: center;
                padding: 25px;
                background: linear-gradient(135deg, #e74c3c, #c0392b);
                color: white;
                border-radius: 10px;
                margin-top: 20px;
                animation: simulatorFadeIn 0.5s ease-in;
            }

            .simulator-ineligible-message.show {
                display: block;
            }

            .simulator-ineligible-message h3 {
                font-size: 20px;
                margin-bottom: 15px;
            }

            .simulator-ineligible-message p {
                font-size: 14px;
                line-height: 1.4;
                margin-bottom: 10px;
            }

            .simulator-ineligible-message .alternative-info {
                background: rgba(255,255,255,0.1);
                padding: 15px;
                border-radius: 8px;
                margin-top: 15px;
                font-size: 13px;
            }

            .simulator-result h3 {
                font-size: 20px;
                margin-bottom: 15px;
            }

            .simulator-result-amount {
                font-size: 28px;
                font-weight: bold;
                margin-bottom: 10px;
            }

            .simulator-result-details {
                font-size: 14px;
                line-height: 1.4;
            }

            @keyframes simulatorFadeIn {
                from { opacity: 0; transform: translateY(15px); }
                to { opacity: 1; transform: translateY(0); }
            }

            @media (max-width: 768px) {
                .simulator-content {
                    padding: 20px;
                }
                
                .simulator-buttons {
                    flex-direction: column;
                }
                
                .simulator-btn {
                    width: 100%;
                }
            }
        `;

        // HTML du simulateur
        const simulatorHTML = `
            <div class="maprimeadapt-simulator">
                <div class="simulator-header">
                    <h2>üè† Simulateur MaPrimeAdapt</h2>
                    <p>D√©couvrez votre √©ligibilit√© et le montant de votre aide en 2 minutes</p>
                </div>
                
                <div class="simulator-progress-bar">
                    <div class="simulator-progress-fill"></div>
                </div>

                <div class="simulator-content">
                    <form class="simulator-form">
                        <!-- Question 1 -->
                        <div class="simulator-question active" data-question="1">
                            <h3 class="simulator-question-title">üè† Votre logement</h3>
                            <p class="simulator-question-subtitle">Votre projet concerne-t-il votre r√©sidence principale ?</p>
                            <div class="simulator-options">
                                <div class="simulator-option" data-value="oui">‚úÖ Oui</div>
                                <div class="simulator-option" data-value="non">‚ùå Non</div>
                            </div>
                        </div>

                        <!-- Question 2 -->
                        <div class="simulator-question" data-question="2">
                            <h3 class="simulator-question-title">üè† Statut d'occupation</h3>
                            <p class="simulator-question-subtitle">Concernant ce logement, vous √™tes :</p>
                            <div class="simulator-options">
                                <div class="simulator-option" data-value="proprietaire">üè† Propri√©taire occupant</div>
                                <div class="simulator-option" data-value="locataire_prive">üè† Locataire - logement priv√©</div>
                                <div class="simulator-option" data-value="locataire_social">üè† Locataire - logement social</div>
                                <div class="simulator-option" data-value="autre">üè† Autre situation</div>
                            </div>
                        </div>

                        <!-- Question 3 -->
                        <div class="simulator-question" data-question="3">
                            <h3 class="simulator-question-title">üë§ Votre √¢ge</h3>
                            <p class="simulator-question-subtitle">Quel √¢ge avez-vous ?</p>
                            <div class="simulator-options">
                                <div class="simulator-option" data-value="moins_60">Moins de 60 ans</div>
                                <div class="simulator-option" data-value="60_69">Entre 60 et 69 ans</div>
                                <div class="simulator-option" data-value="70_plus">70 ans ou plus</div>
                            </div>
                        </div>

                        <!-- Question 4 -->
                        <div class="simulator-question" data-question="4">
                            <h3 class="simulator-question-title">‚ôø Situation de handicap</h3>
                            <p class="simulator-question-subtitle">√ätes-vous en situation de handicap ?</p>
                            <div class="simulator-options">
                                <div class="simulator-option" data-value="oui">‚úÖ Oui (taux ‚â• 50% ou PCH)</div>
                                <div class="simulator-option" data-value="non">‚ùå Non</div>
                                <div class="simulator-option" data-value="ne_sais_pas">‚ùì Je ne sais pas</div>
                            </div>
                        </div>

                        <!-- Question 5 -->
                        <div class="simulator-question" data-question="5">
                            <h3 class="simulator-question-title">üë• Votre foyer</h3>
                            <div class="simulator-input-group">
                                <label for="sim-codePostal">Code postal :</label>
                                <input type="text" id="sim-codePostal" maxlength="5" placeholder="69000" required>
                            </div>
                            <div class="simulator-input-group">
                                <label>Nombre de personnes dans le foyer :</label>
                                <div class="simulator-options">
                                    <div class="simulator-option" data-value="1">1 personne</div>
                                    <div class="simulator-option" data-value="2">2 personnes</div>
                                    <div class="simulator-option" data-value="3">3 personnes</div>
                                    <div class="simulator-option" data-value="4">4 personnes</div>
                                    <div class="simulator-option" data-value="5">5 personnes</div>
                                    <div class="simulator-option" data-value="6">6 personnes ou plus</div>
                                </div>
                            </div>
                        </div>

                        <!-- Question 6 -->
                        <div class="simulator-question" data-question="6">
                            <h3 class="simulator-question-title">üí∞ Vos revenus</h3>
                            <p class="simulator-question-subtitle">Revenu fiscal de r√©f√©rence total du foyer :</p>
                            <div class="simulator-options">
                                <div class="simulator-option" data-value="moins_20000">Moins de 20 000‚Ç¨</div>
                                <div class="simulator-option" data-value="20000_30000">Entre 20 000‚Ç¨ et 30 000‚Ç¨</div>
                                <div class="simulator-option" data-value="30000_40000">Entre 30 000‚Ç¨ et 40 000‚Ç¨</div>
                                <div class="simulator-option" data-value="plus_40000">Plus de 40 000‚Ç¨</div>
                            </div>
                        </div>

                        <!-- Question 7 -->
                        <div class="simulator-question" data-question="7">
                            <h3 class="simulator-question-title">üîß Votre projet</h3>
                            <p class="simulator-question-subtitle">Quels travaux envisagez-vous ? (S√©lection multiple possible)</p>
                            <div class="simulator-options">
                                <div class="simulator-option" data-value="douche">üöø Douche de plain-pied</div>
                                <div class="simulator-option" data-value="monte_escalier">ü™ú Monte-escalier</div>
                                <div class="simulator-option" data-value="barres_appui">üõ°Ô∏è Barres d'appui</div>
                                <div class="simulator-option" data-value="rampes">üè† Rampes d'acc√®s</div>
                                <div class="simulator-option" data-value="a_definir">ü§∑ √Ä d√©finir</div>
                            </div>
                        </div>

                        <!-- Question 8 -->
                        <div class="simulator-question" data-question="8">
                            <h3 class="simulator-question-title">üìß Recevez votre estimation</h3>
                            <p class="simulator-question-subtitle">Remplissez ce formulaire pour recevoir votre estimation par email</p>
                            <div class="simulator-input-group">
                                <label for="sim-prenom">Pr√©nom :</label>
                                <input type="text" id="sim-prenom" placeholder="Jean" required>
                            </div>
                            <div class="simulator-input-group">
                                <label for="sim-nom">Nom :</label>
                                <input type="text" id="sim-nom" placeholder="Dupont" required>
                            </div>
                            <div class="simulator-input-group">
                                <label for="sim-email">Adresse mail :</label>
                                <input type="email" id="sim-email" placeholder="jean.dupont@email.com" required>
                            </div>
                            <div class="simulator-input-group">
                                <label for="sim-telephone">Num√©ro de t√©l√©phone :</label>
                                <input type="tel" id="sim-telephone" placeholder="06 12 34 56 78" required>
                            </div>
                        </div>

                        <!-- Message d'in√©ligibilit√© -->
                        <div class="simulator-ineligible-message">
                            <h3>D√©sol√©, vous n'√™tes pas √©ligible √† MaPrimeAdapt</h3>
                            <div class="simulator-ineligible-reason"></div>
                            <div class="alternative-info">
                                <strong>üí° Alternatives possibles :</strong><br>
                                ‚Ä¢ Cr√©dit d'imp√¥t pour l'accessibilit√©<br>
                                ‚Ä¢ Aides locales de votre commune<br>
                                ‚Ä¢ Aides des caisses de retraite<br>
                                ‚Ä¢ Pr√™t √† l'am√©lioration de l'habitat
                            </div>
                            <p style="margin-top: 15px;">
                                üìû <strong>Contactez-nous</strong> pour √©tudier d'autres solutions de financement adapt√©es √† votre situation.
                            </p>
                        </div>

                        <!-- R√©sultat -->
                        <div class="simulator-result">
                            <h3>üéØ Votre estimation MaPrimeAdapt</h3>
                            <div class="simulator-result-amount">Calcul en cours...</div>
                            <div class="simulator-result-details"></div>
                            <p style="margin-top: 15px; font-size: 14px;">
                                üìß Estimation d√©taill√©e envoy√©e par email<br>
                                üìû Nos conseillers vous contacteront sous 24h
                            </p>
                        </div>

                        <div class="simulator-buttons">
                            <button type="button" class="simulator-btn simulator-btn-secondary simulator-prev-btn" style="display: none;">‚Üê Pr√©c√©dent</button>
                            <button type="button" class="simulator-btn simulator-btn-primary simulator-next-btn">Suivant ‚Üí</button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        // Classe JavaScript du simulateur
        class MaPrimeAdaptSimulator {
            constructor(containerId) {
                this.containerId = containerId;
                this.container = document.getElementById(containerId);
                this.currentQuestion = 1;
                this.totalQuestions = 8;
                this.responses = {};
                this.init();
            }

            init() {
                this.injectStyles();
                this.injectHTML();
                this.bindEvents();
                this.updateProgress();
                this.updateButtons();
            }

            injectStyles() {
                const style = document.createElement('style');
                style.textContent = simulatorCSS;
                document.head.appendChild(style);
            }

            injectHTML() {
                this.container.innerHTML = simulatorHTML;
            }

            bindEvents() {
                const simulator = this.container.querySelector('.maprimeadapt-simulator');
                
                // Options selection
                simulator.querySelectorAll('.simulator-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const questionDiv = e.target.closest('.simulator-question');
                        const questionNum = questionDiv.dataset.question;
                        
                        // Special handling for question 7 (multiple selection)
                        if (questionNum === '7') {
                            // Toggle selection for question 7
                            e.target.classList.toggle('selected');
                            
                            // Store multiple selections
                            const selectedOptions = Array.from(questionDiv.querySelectorAll('.simulator-option.selected'))
                                .map(opt => opt.dataset.value);
                            this.responses[`question_${questionNum}`] = selectedOptions;
                            
                            // Don't auto-advance for question 7
                            return;
                        }
                        
                        // Regular single selection for other questions
                        // Remove selection from siblings
                        questionDiv.querySelectorAll('.simulator-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        
                        // Add selection to clicked option
                        e.target.classList.add('selected');
                        
                        // Store response
                        this.responses[`question_${questionNum}`] = e.target.dataset.value;
                        
                        // Auto-advance for some questions
                        if (questionNum <= 4 || questionNum == 6) {
                            setTimeout(() => {
                                this.nextQuestion();
                            }, 500);
                        }
                    });
                });

                // Navigation buttons
                simulator.querySelector('.simulator-next-btn').addEventListener('click', () => {
                    this.nextQuestion();
                });

                simulator.querySelector('.simulator-prev-btn').addEventListener('click', () => {
                    this.previousQuestion();
                });

                // Code postal validation
                simulator.querySelector('#sim-codePostal').addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            }

            nextQuestion() {
                if (!this.validateCurrentQuestion()) {
                    return;
                }

                if (!this.checkEligibility()) {
                    return;
                }

                if (this.currentQuestion === this.totalQuestions) {
                    this.showResult();
                    return;
                }

                // Skip handicap question if 70+
                if (this.currentQuestion === 3 && this.responses.question_3 === '70_plus') {
                    this.currentQuestion = 5;
                } else {
                    this.currentQuestion++;
                }

                this.showQuestion();
            }

            previousQuestion() {
                if (this.currentQuestion > 1) {
                    if (this.currentQuestion === 5 && this.responses.question_3 === '70_plus') {
                        this.currentQuestion = 3;
                    } else {
                        this.currentQuestion--;
                    }
                    this.showQuestion();
                }
            }

            showQuestion() {
                const simulator = this.container.querySelector('.maprimeadapt-simulator');
                
                // Hide all questions
                simulator.querySelectorAll('.simulator-question').forEach(q => {
                    q.classList.remove('active');
                });

                // Show current question
                const currentQuestionDiv = simulator.querySelector(`[data-question="${this.currentQuestion}"]`);
                if (currentQuestionDiv) {
                    currentQuestionDiv.classList.add('active');
                    
                    // Focus on pr√©nom field when reaching question 8
                    if (this.currentQuestion === 8) {
                        setTimeout(() => {
                            const prenomInput = simulator.querySelector('#sim-prenom');
                            if (prenomInput) {
                                prenomInput.focus();
                            }
                        }, 100);
                    }
                }

                this.updateProgress();
                this.updateButtons();
            }

            validateCurrentQuestion() {
                const simulator = this.container.querySelector('.maprimeadapt-simulator');
                const currentQuestionDiv = simulator.querySelector(`[data-question="${this.currentQuestion}"]`);
                
                if (this.currentQuestion === 5) {
                    const codePostal = simulator.querySelector('#sim-codePostal').value;
                    const foyerSize = this.responses.question_5;
                    
                    if (!codePostal || codePostal.length !== 5) {
                        this.showValidationError('Veuillez saisir un code postal valide (5 chiffres)');
                        return false;
                    }
                    
                    if (!foyerSize) {
                        this.showValidationError('Veuillez s√©lectionner le nombre de personnes dans votre foyer');
                        return false;
                    }
                    
                    this.responses.codePostal = codePostal;
                    return true;
                }

                if (this.currentQuestion === 7) {
                    // Question 7 is optional, so always valid
                    return true;
                }

                if (this.currentQuestion === 8) {
                    const prenom = simulator.querySelector('#sim-prenom').value;
                    const nom = simulator.querySelector('#sim-nom').value;
                    const email = simulator.querySelector('#sim-email').value;
                    const telephone = simulator.querySelector('#sim-telephone').value;
                    
                    if (!prenom || !nom || !email || !telephone) {
                        this.showValidationError('Veuillez remplir tous les champs obligatoires');
                        return false;
                    }
                    
                    // Validation email simple
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        this.showValidationError('Veuillez saisir une adresse email valide');
                        return false;
                    }
                    
                    this.responses.prenom = prenom;
                    this.responses.nom = nom;
                    this.responses.email = email;
                    this.responses.telephone = telephone;
                    
                    return true;
                }

                const selectedOption = currentQuestionDiv.querySelector('.simulator-option.selected');
                if (!selectedOption) {
                    this.showValidationError('Veuillez s√©lectionner une option');
                    return false;
                }

                return true;
            }

            showValidationError(message) {
                const simulator = this.container.querySelector('.maprimeadapt-simulator');
                
                // Remove existing error message
                const existingError = simulator.querySelector('.validation-error');
                if (existingError) {
                    existingError.remove();
                }
                
                // Create error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'validation-error';
                errorDiv.style.cssText = `
                    background: #e74c3c;
                    color: white;
                    padding: 10px;
                    border-radius: 5px;
                    margin-bottom: 15px;
                    font-size: 14px;
                    animation: simulatorFadeIn 0.3s ease-in;
                `;
                errorDiv.textContent = message;
                
                // Insert error message
                const currentQuestion = simulator.querySelector('.simulator-question.active');
                const buttons = simulator.querySelector('.simulator-buttons');
                buttons.parentNode.insertBefore(errorDiv, buttons);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 5000);
            }

            checkEligibility() {
                // Check residence principale
                if (this.responses.question_1 === 'non') {
                    this.showIneligibilityMessage(
                        'R√©sidence secondaire',
                        'MaPrimeAdapt ne concerne que les r√©sidences principales.',
                        'Pour adapter une r√©sidence secondaire, vous pouvez vous tourner vers :<br>‚Ä¢ Le cr√©dit d\'imp√¥t pour l\'accessibilit√©<br>‚Ä¢ Les aides locales de votre commune<br>‚Ä¢ Un financement priv√©'
                    );
                    return false;
                }

                // Check statut occupation
                if (this.responses.question_2 === 'locataire_social') {
                    this.showIneligibilityMessage(
                        'Logement social',
                        'MaPrimeAdapt ne concerne que les propri√©taires occupants et locataires du parc priv√©.',
                        'Pour un logement social, contactez :<br>‚Ä¢ Votre bailleur social<br>‚Ä¢ Le service social de votre mairie<br>‚Ä¢ Les associations d\'aide aux personnes √¢g√©es'
                    );
                    return false;
                }

                // Check age and handicap
                if (this.responses.question_3 === 'moins_60' && this.responses.question_4 === 'non') {
                    this.showIneligibilityMessage(
                        'Crit√®res d\'√¢ge et de handicap',
                        'Pour √™tre √©ligible √† MaPrimeAdapt, vous devez avoir au moins 60 ans ou √™tre en situation de handicap (taux ‚â• 50%).',
                        'Solutions possibles :<br>‚Ä¢ Cr√©dit d\'imp√¥t pour l\'accessibilit√©<br>‚Ä¢ Aides de votre mutuelle<br>‚Ä¢ Pr√™t √† l\'am√©lioration de l\'habitat<br>‚Ä¢ Aides locales sp√©cifiques'
                    );
                    return false;
                }

                return true;
            }

            showIneligibilityMessage(title, reason, alternatives) {
                const simulator = this.container.querySelector('.maprimeadapt-simulator');
                const ineligibleDiv = simulator.querySelector('.simulator-ineligible-message');
                const reasonDiv = simulator.querySelector('.simulator-ineligible-reason');
                const alternativeDiv = simulator.querySelector('.alternative-info');
                
                // Hide all questions
                simulator.querySelectorAll('.simulator-question').forEach(q => {
                    q.classList.remove('active');
                    q.style.display = 'none';
                });
                
                // Hide navigation buttons
                simulator.querySelector('.simulator-next-btn').style.display = 'none';
                simulator.querySelector('.simulator-prev-btn').style.display = 'none';
                
                // Update content (removed the emoji)
                reasonDiv.innerHTML = `
                    <p style="margin-bottom: 15px;"><strong>Raison :</strong> ${reason}</p>
                `;
                
                alternativeDiv.innerHTML = `
                    <strong>üí° Alternatives possibles :</strong><br>
                    ${alternatives}
                `;
                
                // Show message
                ineligibleDiv.classList.add('show');
                
                // Add retry button
                const retryButton = document.createElement('button');
                retryButton.className = 'simulator-btn simulator-btn-secondary';
                retryButton.style.marginTop = '20px';
                retryButton.textContent = '‚Üê Recommencer';
                retryButton.onclick = () => this.restartSimulator();
                
                if (!ineligibleDiv.querySelector('.simulator-btn')) {
                    ineligibleDiv.appendChild(retryButton);
                }
            }

            restartSimulator() {
                // Reset state
                this.currentQuestion = 1;
                this.responses = {};
                
                const simulator = this.container.querySelector('.maprimeadapt-simulator');
                
                // Hide ineligible message
                simulator.querySelector('.simulator-ineligible-message').classList.remove('show');
                
                // Reset all questions: remove any inline styles and active classes
                simulator.querySelectorAll('.simulator-question').forEach(q => {
                    q.style.display = '';  // Remove any inline display style
                    q.classList.remove('active');  // Remove active class
                });
                
                // Reset form
                simulator.querySelectorAll('.simulator-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                simulator.querySelectorAll('input').forEach(input => {
                    input.value = '';
                    if (input.type === 'checkbox') input.checked = false;
                });
                
                // Remove any existing validation errors
                const existingError = simulator.querySelector('.validation-error');
                if (existingError) {
                    existingError.remove();
                }
                
                // Show only the first question
                simulator.querySelector('[data-question="1"]').classList.add('active');
                
                // Restore navigation buttons
                simulator.querySelector('.simulator-next-btn').style.display = 'block';
                simulator.querySelector('.simulator-prev-btn').style.display = 'none';
                
                // Update progress and buttons
                this.updateProgress();
                this.updateButtons();
            }

            calculateEligibility() {
                const codePostal = this.responses.codePostal;
                const foyerSize = parseInt(this.responses.question_5);
                const revenus = this.responses.question_6;
                
                const idfCodes = ['75', '77', '78', '91', '92', '93', '94', '95'];
                const isIleDeFrance = idfCodes.includes(codePostal.substring(0, 2));
                
                const plafonds = {
                    idf: {
                        tres_modeste: [23768, 34884, 41893, 48914, 55961],
                        modeste: [28933, 42463, 51000, 59549, 68123]
                    },
                    province: {
                        tres_modeste: [17173, 25115, 30206, 35285, 40388],
                        modeste: [22015, 32197, 38719, 45234, 51775]
                    }
                };
                
                const region = isIleDeFrance ? 'idf' : 'province';
                const plafondIndex = Math.min(foyerSize - 1, 4);
                
                let revenuEstime = 0;
                switch(revenus) {
                    case 'moins_20000': revenuEstime = 18000; break;
                    case '20000_30000': revenuEstime = 25000; break;
                    case '30000_40000': revenuEstime = 35000; break;
                    case 'plus_40000': revenuEstime = 45000; break;
                }
                
                const plafondTresModeste = plafonds[region].tres_modeste[plafondIndex];
                const plafondModeste = plafonds[region].modeste[plafondIndex];
                
                if (revenuEstime <= plafondTresModeste) {
                    return { eligible: true, taux: 70, montant: 15400, categorie: 'tr√®s modeste' };
                } else if (revenuEstime <= plafondModeste) {
                    return { eligible: true, taux: 50, montant: 11000, categorie: 'modeste' };
                } else {
                    return { eligible: false, taux: 0, montant: 0, categorie: 'non √©ligible' };
                }
            }

            showResult() {
                const simulator = this.container.querySelector('.maprimeadapt-simulator');
                const eligibility = this.calculateEligibility();
                
                const resultDiv = simulator.querySelector('.simulator-result');
                const amountDiv = simulator.querySelector('.simulator-result-amount');
                const detailsDiv = simulator.querySelector('.simulator-result-details');
                
                if (eligibility.eligible) {
                    amountDiv.innerHTML = `Jusqu'√† ${eligibility.montant.toLocaleString()}‚Ç¨`;
                    detailsDiv.innerHTML = `
                        <p>‚úÖ Vous √™tes √©ligible √† MaPrimeAdapt</p>
                        <p>üìä Revenus ${eligibility.categorie} : ${eligibility.taux}% de prise en charge</p>
                        <p>üí∞ Montant maximum : ${eligibility.montant.toLocaleString()}‚Ç¨</p>
                    `;
                } else {
                    amountDiv.innerHTML = `Non √©ligible`;
                    detailsDiv.innerHTML = `
                        <p>‚ùå Vos revenus d√©passent les plafonds MaPrimeAdapt</p>
                        <p>üí° D'autres aides peuvent exister (cr√©dit d'imp√¥t, aides locales)</p>
                    `;
                }
                
                resultDiv.classList.add('show');
                simulator.querySelector('.simulator-next-btn').style.display = 'none';
                simulator.querySelector('.simulator-prev-btn').style.display = 'none';
                
                this.sendData();
            }

            sendData() {
                // Callback pour l'int√©gration
                if (typeof window.onMaPrimeAdaptComplete === 'function') {
                    window.onMaPrimeAdaptComplete(this.responses);
                }
                
                console.log('Donn√©es du simulateur:', this.responses);
            }

            updateProgress() {
                const simulator = this.container.querySelector('.maprimeadapt-simulator');
                const progress = (this.currentQuestion / this.totalQuestions) * 100;
                simulator.querySelector('.simulator-progress-fill').style.width = `${progress}%`;
            }

            updateButtons() {
                const simulator = this.container.querySelector('.maprimeadapt-simulator');
                const prevBtn = simulator.querySelector('.simulator-prev-btn');
                const nextBtn = simulator.querySelector('.simulator-next-btn');
                
                prevBtn.style.display = this.currentQuestion > 1 ? 'block' : 'none';
                
                if (this.currentQuestion === this.totalQuestions) {
                    nextBtn.textContent = 'Calculer mon estimation';
                } else {
                    nextBtn.textContent = 'Suivant ‚Üí';
                }
            }
        }

        // Initialisation automatique
        document.addEventListener('DOMContentLoaded', () => {
            new MaPrimeAdaptSimulator('maprimeadapt-simulator');
        });
    </script>
</body>
</html>